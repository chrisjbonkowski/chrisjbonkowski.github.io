<html>
    <head>
        <title>WebUSB ISX comms</title>
    </head>

    
    <body>
        <script>
         var isxbase = {
         };
         var toVSMF;
         var fromVSMF;
         
         (function() {
           'use strict';
           
           function toUTF8Array(str) {
             var utf8 = [];
             for (var i = 0; i < str.length; i++) {
               var charcode = str.charCodeAt(i);
               if (charcode < 0x80) utf8.push(charcode);
               else if (charcode < 0x800) {
                 utf8.push(0xc0 | (charcode >> 6), 0x80 | (charcode & 0x3f));
               } else if (charcode < 0xd800 || charcode >= 0xe000) {
                 utf8.push(
                   0xe0 | (charcode >> 12),
                   0x80 | ((charcode >> 6) & 0x3f),
                   0x80 | (charcode & 0x3f)
                 );
               }
               // surrogate pair
               else {
                 i++;
                 // UTF-16 encodes 0x10000-0x10FFFF by
                 // subtracting 0x10000 and splitting the
                 // 20 bits of 0x0-0xFFFFF into two halves
                 charcode =
                   0x10000 + (((charcode & 0x3ff) << 10) | (str.charCodeAt(i) & 0x3ff));
                 utf8.push(
                   0xf0 | (charcode >> 18),
                   0x80 | ((charcode >> 12) & 0x3f),
                   0x80 | ((charcode >> 6) & 0x3f),
                   0x80 | (charcode & 0x3f)
                 );
               }
             }
             return utf8;
           }
           
           const ToBase64 = function (u8) {
             return btoa(String.fromCharCode.apply(null, u8));
           }
           const FromBase64 = function (str) {
             return atob(str).split('').map(function (c) { return c.charCodeAt(0); });
           }

           const CBuf = function(buffer, start, len) {
             this.buffer = buffer;
             this.s = start || 0;
             this.len = len || buffer.length;
             this.o = 0;
           }
           CBuf.prototype.byte = function() {
             this.o += 1;
             return this.buffer[this.s+this.o-1];
           }
           CBuf.prototype.readEint = function() {
             const e = this.byte();
             if(e < 0xfc) return e;
             let l = 0;
             if(e == 0xfc) l = 2;
             else if(e == 0xfd) l = 4;
             else if(e == 0xfe) l = 8;
             else l = this.readEint();
             let val = 0;
             while(l--) {
               val = val * 256 + this.byte();
             }
             return val;
           }
           CBuf.prototype.readString = function(l) {
             function utf8_to_str(a) {
               for(var i=0, s=''; i<a.length; i++) {
                 var h = a[i].toString(16)
                 if(h.length < 2) h = '0' + h
                 s += '%' + h
               }
               return decodeURIComponent(s)
             }
             const a = utf8_to_str(this.buffer.slice(this.s+this.o, this.s+this.o+l))
             this.o += l;
             return a;
           }
           CBuf.prototype.readBinary = function(l) {
             const a = ToBase64(this.buffer.slice(this.s+this.o,this.s+this.o+l));
             this.o += l;
             return a;
           }
           CBuf.prototype.readVSMF = function(l) {
             const backup = this.o;
             const typ = this.byte();
             const abc = typ >> 5;
             const defgh = typ & 0x1f;
             let tl, kind, id;
             if(abc == 6) {//complex
               const d = defgh >> 4;
               const e = (defgh >> 3) & 1;
               const fgh = defgh & 7;
               tl = (d == 0) ? -1 : this.readEint();
               kind = (e == 0) ? 1 : this.readEint();
               id = (fgh != 7) ? fgh : this.readBinary(this.readEint());
             } else {
               if(abc == 7) {
                 tl = this.readEint();
               } else {
                 tl = [0,1,2,4,8,-1][abc];
               }
               kind = 0;
               if(defgh != 0x1f) {
                 id = defgh;
               } else {
                 id = this.readBinary(this.readEint());
               }
             }
             if(kind != 0) throw "yikes"; //not yet support HOMAR STRUCT
             if(tl == -1) tl = this.readEint();
             const end = this.o + tl;
             switch(id) {
               case 2: //array
                 {
                   const ret = [];
                   while(this.o < end) {
                     ret.push(this.readVSMF());
                   }
                   return ret;
                 }
               case 3: //UUID
                 return { '':['UUID', this.readBinary(tl)] };
               case 5: //string
                 return this.readString(tl);
               case 6: //eform
                 {
                   const ret = {};
                   while(this.o < end) {
                     const k = this.readString(this.readEint());
                     const vl = this.readEint();
                     const v = this.readVSMF(vl);
                     ret[k] = v;
                   }
                   return ret;
                 }
               case 8: //lsb int
                 {
                   if(tl == 0) return null;
                   let ret = 0, mult = 1, tw = 2**(tl*8);
                   while(tl--) {
                     let b = this.byte();
                     neg = b & 128;
                     ret += b*mult;
                     mult *= 256;
                   }
                   if(neg) ret = -(tw - ret);
                   return ret;
                 }
               case 9: //msb int
                 {
                   if(tl == 0) return true; //legacy
                   let ret = this.byte(), neg = ret & 128, tw = 2**(tl*8);
                   while(--tl) {
                     ret = ret*256 + this.byte();
                   }
                   if(neg) ret = -(tw - ret);
                   return ret;
                 }
               case 10: //Bool
                 if(tl == 0) return false;
                 let b = 0;
                 while(tl--) {
                   b |= this.byte();
                 }
                 return b ? true : false;
               case 15: //Bin
                 return {'':['Binary',this.readBinary(tl)]};
               default:
                 console.log("UNKTYPE",typ, id);
                 const ret = {'':["VSMF", this.buffer.slice(this.start + backup, this.start + this.o + tl)]};
                 this.o += tl;
                 return ret;
             }
           }
           
           toVSMF = function(o) {
             const writeEint = function(n) {
               if(n < 0xfc) return [n];
               if(n < 0xffff) return [0xfc, n>>8, n&255 ];
               if(n < 0xffffffff) return [0xfd,(n>>24)&255,(n>>16)&255,(n>>8)&255, n&255 ];
               throw "too big";
             }
             const varType = function (id, data, fix=false) {
               const l = data.length;
               if(l <= 8 && fix && (x=[0x00,0x20,0x40,-1,0x60,-1,-1,-1,0x80][l]) != -1) return [(id + x), ...data]
               return [(id + 0xa0), ...writeEint(l), ...data];
             }
             switch(typeof(o)) {
               case 'boolean': {
                 return [0x2a, o ? 1 : 0];
               }
               case 'number': {
                 if(!Number.isNaN(o) && Number.isInteger(o)) {
                   const buf = new ArrayBuffer(8);
                   if(o >= -0x8000 && o <= 0x07fff) {
                     new DataView(buf).setInt16(0,o)
                     const ret = [73]
                     ret.push(...(new Uint8Array(buf,0,2)));
                     return ret
                   } else if(o >= -2147483648 && o <= 0x07fffffff) {
                     new DataView(buf).setBigInt32(0,o)                     
                     const ret = [105]
                     ret.push(...(new Uint8Array(buf,0,4)));
                     return ret
                   } else {
                     new DataView(buf).setBigInt64(0,o)
                     const ret = [137]
                     ret.push(...(new Uint8Array(buf,0,8)));
                     return ret
                   }
                 }
                 console.log("float not supported");
                 throw("float not supported");
               }
               case 'string': {
                 return varType(5,toUTF8Array(o));
               }
               case 'object': {
                 if(Array.isArray(o)) {
                   const elems = o.map(toVSMF).reduce((a, e) => [...a, ...e], []);
                   return varType(2,elems)
                 } else {
                   const keys = Object.keys(o);
                   if(keys.length == 1 && keys[0] === '') { //special
                     const special = o[''];
                     if(Array.isArray(special) && special.length > 1) {
                       switch(special[0]) {
                         case "Binary":
                           return varType(15,FromBase64(special[1]))
                         case "UUID":
                           return varType(3,FromBase64(special[1]))
                         case "VSMF":
                           todo();
                       }
                     }
                   } else {
                     const ret = []
                     keys.sort();
                     keys.reduce((ret, k)=> {
                       const k8 = toUTF8Array(k);
                       ret.push(...writeEint(k8.length));
                       ret.push(...k8)
                       const vv = toVSMF(o[k]);
                       ret.push(...writeEint(vv.length));
                       ret.push(...vv)
                       return ret;
                     }, ret);
                     return varType(6,ret);
                   }
                 }
             }}
             console.log("cannot convert",o);
             throw("Cannot convert",o);
           }
           
           isxbase.getPorts = function() {
             return navigator.usb.getDevices().then(devices => {
               return devices.map(device => new isxbase.Port(device));
             });
           };
           
           isxbase.requestPort = function() {
             const filters = [
               { 'vendorId': 0x0925, 'productId': 0x9099 }
             ];
             return navigator.usb.requestDevice({ 'filters': filters }).then(
               device => new isxbase.Port(device)
             );
           }
           
           isxbase.Port = function(device) {
             this.device_ = device;
           };

           fromVSMF = function(m) {
             const cBuf = new CBuf(m);
             return cBuf.readVSMF();
           }
           
           isxbase.Port.prototype.handleMessage = function(ky,m) {
             console.log("Message",ky,m);
             const cBuf = new CBuf(m);
             const result = cBuf.readVSMF();
             if(ky == "0:12") {
               document.getElementById('output').value = JSON.stringify(result);
             }
             
           }
           
           isxbase.Port.prototype.resetState = function() {
             this.iesc = 0;
             this.module = 0;
             this.selected = {};
             this.inState = {};
             this.pendingWrite = 0;
             this.syncbuf = 0;
           }

           isxbase.Port.prototype.getSelected = function(m) {
             if(!this.selected[m] || this.selected[m].length == 0) {
               this.selected[m] = [0];
             }
             return this.selected[m];
           }
           isxbase.Port.prototype.setSelected = function(m,s) {
             this.selected[m] = [s];
           }
           isxbase.Port.prototype.addSelected = function(m,s) {
             this.selected[m].push(s);
           }

           isxbase.Port.prototype.processInput = function(data) {
             for(let i = 0; i < data.length; i++) {               
               let c = data[i];
               if(c == 0xff) {
                 this.resetState();
                 continue;
               } else if(this.iesc == 254) {
                 this.iesc = 0;
                 if(c < 128) {
                   this.module = c;
                   continue;
                 } else if(c > 251) {
                   c += 1;
                 } else if(c == 251) {
                   this.iesc = 2000;
                   continue;
                 } else if(c == 250) {
                   c = -1;
                 } else {
                   console.log("Protocol violation!");
                   this.resetState();
                 }
               } else if(this.iesc == 253) {
                 this.iesc = 0;
                 if(c < 128) {
                   this.setSelected(this.module, c);
                 } else if(c < 254) {
                   this.addSelected(this.module,c-128);
                 } else {
                   this.iesc = 1000;
                 }
                 continue;
               } else if(this.iesc == 1000) {
                 this.iesc = 0;
                 this.getSelected(this.module).push(c-252+125)
                 continue;
               } else if(this.iesc == 2000) {
                 this.oob_len = c
                 if(c > 0) {
                   this.iesc = 2001;
                   this.oob = [];
                 } else {
                   this.iesc = 0;
                 }
                 continue;
               } else if(this.iesc == 2001) {
                 this.oob.push(c);
                 this.oob_len -= 1;
                 if(this.oob_len === 0) {
                   console.log("OOB:",this.oob);
                   if(this.oob == "Isx01") {
                     //a reset happened
                     this.syncbuf = 1;
                   }
                   this.iesc = 0;
                 }
                 continue;
               } else if(c == 254 || c == 253) {
                 this.iesc = c;
                 continue;
               }
               //reading a msg to module/selected
               let KY = this.module+":"+this.getSelected(this.module).join('-')
               let ST = this.inState[KY];
               if(c == -1) { //EOM
                 if(ST) {
                   this.handleMessage(KY,ST[1]);
                   ST[0] = 0;
                   ST[1] = [];
                 }
               } else {
                 if(!ST) {
                   ST = [0,[]];
                   this.inState[KY] = ST;
                 }
                 if(this.syncbuf) {
                   this.syncbuf = 0;
                   ST[1] = [];
                   ST[0] = 0;
                 }
                 ST[1].push(c);
                 ST[0] += 1;
               }
             }
           }
           
           isxbase.Port.prototype.connect = function() {
             let readLoop = () => {
               const {
                 endpointNumber
               } = this.device_.configuration.interfaces[0].alternate.endpoints[0]
               this.device_.transferIn(endpointNumber, 64).then(result => {
                 this.onReceive(result.data);
                 readLoop();
               }, error => {
                 this.onReceiveError(error);
               });
             };
             
             return this.device_.open()
                        .then(() => {
                          if (this.device_.configuration === null) {
                            return this.device_.selectConfiguration(1);
                          }
                        })
                        .then(() => this.device_.claimInterface(0))
                        .then(() => {
                          this.resetState();
                          readLoop();
                        });
           };

           isxbase.Port.prototype.disconnect = function() {
             return this.device_.close();
           };

           isxbase.Port.prototype.send = function(data) {
             const {
               endpointNumber
             } = this.device_.configuration.interfaces[0].alternate.endpoints[1]
             return this.device_.transferOut(endpointNumber, data);
           };

           isxbase.Port.prototype.sendChunksSlow = function(data) {
             const chunk = 32;
             for(var i=0; i<data.length; i+=chunk) {
               const j = i;
               setTimeout(function(){
                 this.send(data.slice(j,j+chunk));
               }, j*1000/chunk+1); 
             }
           }
           isxbase.Port.prototype.sendChunks = function(data) {
             const chunk = 32;
             for(var i=0; i<data.length; i+=chunk) {
               this.send(data.slice(i,i+chunk));
             }
           }             
         })();
         
         let port;
         
         function connect() {
           port.connect().then(() => {
             port.onReceive = data => {
               port.processInput(new Uint8Array(data.buffer));
               //let textDecoder = new TextDecoder();
               //document.getElementById('output').value += textDecoder.decode(data);
             }
             port.onReceiveError = error => {
               console.error(error);
               document.querySelector("#connect").style = "visibility: initial";
               port.disconnect();
             };
           });
         }

         function send(string) {
           console.log("sending to isxbase:" + string.length);
           if (string.length === 0)
             return;
           console.log("sending to isxbase: [" + string +"]\n");

           let view = new TextEncoder('utf-8').encode(string);
           //send 0xff instead
           view = new Uint8Array([0xff]);
           console.log(view);
           if (port) {
             port.send(view);
           }
         };
         function reset() {
           if(port) {
             console.log("SENDING RESET");
             port.send(new Uint8Array([0xff]));
           }
         }
         function getinfo() {
           if(port) {
             port.send(new Uint8Array([0xfe,0,0xfd,12,0xa5,1,'x',0xfe,250]));
           }
         }
         function convert() {
           const before = JSON.parse(document.getElementById('output').value)
           const after = JSON.stringify(toVSMF(before));
           document.getElementById('output').value = after;
         }
         function reconvert() {
           const before = JSON.parse(document.getElementById('output').value)
           const after = new Uint8Array(toVSMF(before));
           console.log("AFTER",after);
           document.getElementById('output').value = JSON.stringify([...after]);
           const result = JSON.stringify(fromVSMF(after));
           document.getElementById('output').value = result;
         }
         function message(module,term,msg) {
           port.send(new Uint8Array([0xff]));
         }
         
         window.onload = _ => {
           document.querySelector("#connect").onclick = function() {
             isxbase.requestPort().then(selectedPort => {
               port = selectedPort;
               this.style = "visibility: hidden";
               connect();
             });
           }
           
           document.querySelector("#submit").onclick = () => {
             const source = JSON.parse(document.getElementById('output').value)
             const config = toVSMF(source);
             //append message to base terminal 13
             const header = [0xfe, 0, 0xfd, 13];
             const whole = [...header, ...config, 0xfe, 250];
             console.log("Sending",whole);
             port.sendChunks(new Uint8Array(whole));
           }

           document.querySelector("#test").onclick = () => {
            document.getElementById('output').value = "Fetching..."
            const response = fetch("https://uesystems.interstacks.com/api/login", {
                method: 'Post',// *GET, POST, PUT, DELETE, etc.
                //mode: 'cors', // no-cors, *cors, same-origin
                //cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached
                //credentials: 'include', // include, *same-origin, omit
                //headers: {
                //  'content-type': 'application/json',
                //},
                //redirect: 'follow', // manual, *follow, error
                //referrerPolicy: 'origin-when-cross-origin', // no-referrer, *no-referrer-when-downgrade, origin, origin-when-cross-origin, same-origin, strict-origin, strict-origin-when-cross-origin, unsafe-url
                body: JSON.stringify({username: "",password: "",mfactor: ""}) // body data type must match "Content-Type" header
                });
            console.log(response);
           }
           
           document.querySelector("#reset").onclick = () => {
             reset();
           }
           document.querySelector("#get").onclick = () => {
             getinfo();
           }
           document.querySelector("#convert").onclick = () => {
             convert();
           }
           document.querySelector("#reconvert").onclick = () => {
             reconvert();
           }
         }
         
        </script>
        <button id="connect" style="visibility: initial">Connect To WebUSB Device</button>
        <button id="reset" style="visibility: initial">Reset Device</button>
        <button id="get" style="visibility: initial">GET INFO</button>
        <button id="convert" style="visibility: initial">CONVERT</button>
        <button id="reconvert" style="visibility: initial">RECONVERT</button>
        <button id="submit">Send</button>
        <button id="test">Test</button>
        <br><br>
        <label for="title">Session Config: </label> </br>
        <textarea id="output", rows="25" cols="80" id="source"></textarea>
        <svg 
        class="speedometer" 
        width="194.9857635498047px" 
        height="129.98931884765625px" 
        style="width: 194.986px; height: 129.989px;">
          <g 
            class="arc" 
            transform="translate(97.49288177490234, 97.49288177490234)">
            <path 
            class="speedo-segment" 
            fill="#4caf50" 
            d="M-77.49288177490234,-9.490140962233842e-15A77.49288177490234,77.49288177490234,0,0,1,-70.79327014509714,-31.519194595393625L-21.693453207909553,-9.658547651559811A23.746440887451172,23.746440887451172,0,0,0,-23.746440887451172,-2.9081002823958913e-15Z">
            </path>
            <path 
            class="speedo-segment" 
            fill="#4caf50" 
           d="M-70.79327014509714,-31.519194595393625A77.49288177490234,77.49288177490234,0,0,1,-51.85285897053572,-57.58843410235015L-15.889470389884986,-17.64704466901416A23.746440887451172,23.746440887451172,0,0,0,-21.693453207909553,-9.658547651559811Z">
            </path>
           <path 
            class="speedo-segment" 
           fill="#2196f3" 
            d="M-51.85285897053572,-57.58843410235015A77.49288177490234,77.49288177490234,0,0,1,-23.946617411533456,-73.70011017851083L-7.338053790142518,-22.58420734482811A23.746440887451172,23.746440887451172,0,0,0,-15.889470389884986,-17.64704466901416Z">
           </path>
           <path 
           class="speedo-segment" 
           fill="#fdd835" 
           d="M-23.946617411533456,-73.70011017851083A77.49288177490234,77.49288177490234,0,0,1,48.76785066216037,-60.22328011302786L14.944119465332621,-18.454450634659366A23.746440887451172,23.746440887451172,0,0,0,-7.338053790142518,-22.58420734482811Z">
           </path>
           <path 
           class="speedo-segment" 
            fill="#f44336" 
            d="M48.76785066216037,-60.22328011302786A77.49288177490234,77.49288177490234,0,0,1,77.49288177490234,0L23.746440887451172,0A23.746440887451172,23.746440887451172,0,0,0,14.944119465332621,-18.454450634659366Z">
           </path>
          </g>
          <g 
            class="label" 
            transform="translate(97.49288177490234, 97.49288177490234)">
            <text 
            transform="rotate(-90) translate(0, -87.49288177490234)" 
            class="segment-value" 
            style="text-anchor: middle; font-size: 9px; font-weight: bold; fill: rgb(102, 102, 102);">
            0
            </text>
            <text 
            transform="rotate(-66) translate(0, -87.49288177490234)" 
            class="segment-value" 
            style="text-anchor: middle; font-size: 9px; font-weight: bold; fill: rgb(102, 102, 102);">
            8
            </text>
            <text 
            transform="rotate(-42) translate(0, -87.49288177490234)" 
            class="segment-value" 
            style="text-anchor: middle; font-size: 9px; font-weight: bold; fill: rgb(102, 102, 102);">
            16
            </text>
            <text 
            transform="rotate(-18) translate(0, -87.49288177490234)" 
            class="segment-value" 
            style="text-anchor: middle; font-size: 9px; font-weight: bold; fill: rgb(102, 102, 102);">
            24
            </text>
            <text 
            transform="rotate(39) translate(0, -87.49288177490234)" 
            class="segment-value" 
            style="text-anchor: middle; font-size: 9px; font-weight: bold; fill: rgb(102, 102, 102);">
            43
            </text>
            <text 
            transform="rotate(90) translate(0, -87.49288177490234)" 
            class="segment-value" 
            style="text-anchor: middle; font-size: 9px; font-weight: bold; fill: rgb(102, 102, 102);">
            60
            </text>
            </g>
            <g 
              transform="translate(97.49288177490234, 97.49288177490234)">
              <text 
              class="current-value" 
              text-anchor="middle" 
              y="23" style="font-size: 12px; font-weight: bold; fill: rgb(102, 102, 102);">
              7.6
              </text>
              </g>
            <g 
              class="pointer" 
              transform="translate(97.49288177490234, 97.49288177490234)" 
              style="fill: rgb(47, 150, 223);">
              <path 
              d="M5,0C3.333333333333333,-44,1.6666666666666667,-88,0,-88C-1.6666666666666667,-88,-3.333333333333333,0,-5,0C-3.333333333333333,0,-1.6666666666666667,5,0,5C1.6666666666666667,5,3.333333333333333,2.5,5,0" 
              transform="rotate(0) scale(1,1)">
            </path>
            </g>
          </svg>
          <form action='https://uesystems.interstacks.com/api/login'> 
            <label for="username">User Name</label>
            <input type="text" name="username" class="input-text input-text-block w-100" id="username">
            <label for="password">Password</label>
            <input type="text" name="password" class="input-text input-text-block w-100" id="password">
            <input type="hidden" name = "mfactor" id="mfactor" value="">
            <button type="submit" class="btn-submit" id="btnSubmit">Login</button>
          </form>

          <!--<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js">-->
          <script>
            async function handleSubmit(event){
              event.preventDefault();
              const data = new FormData(event.target);
              const mfactor = data.get("mfactor");
              const password = data.get("password");
              const username = data.get("username");
              console.log({username,password,mfactor});
              // Default options are marked with *
              //const response = await $.post(
              //  'https://uesystems.interstacks.com/api/login',
              //  JSON.stringify({username: username,password: password,mfactor: mfactor}),
              //  function(data, status, xhr) {   // success callback function
              //    alert('status: ' + status + ', data: ' + data.responseData);
              //  },
              //  'json');

                // Sending a receiving data in JSON format using GET method
                //      
              var xhr = new XMLHttpRequest();
              var url = "https://uesystems.interstacks.com/api/login";
              xhr.open("Post", url, true);
              xhr.setRequestHeader("Content-Type", "application/json");
              xhr.onreadystatechange = function () {
              if (xhr.readyState === 4 && xhr.status === 200) {
              var json = JSON.parse(xhr.responseText);
              console.log(json);
              }
              };  
              var param = JSON.stringify({"username": username,"password": password,"mfactor": mfactor});
              xhr.send(param);

              //fetch("https://uesystems.interstacks.com/api/login", {
                //method: 'Post',// *GET, POST, PUT, DELETE, etc.
                //mode: 'cors', // no-cors, *cors, same-origin
                //cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached
                //credentials: 'include', // include, *same-origin, omit
                //headers: {
                //  'content-type': 'application/json',
                //},
                //redirect: 'follow', // manual, *follow, error
                //referrerPolicy: 'origin-when-cross-origin', // no-referrer, *no-referrer-when-downgrade, origin, origin-when-cross-origin, same-origin, strict-origin, strict-origin-when-cross-origin, unsafe-url
                //body: JSON.stringify({username: username,password: password,mfactor: mfactor}) // body data type must match "Content-Type" header
                //});
                //return response.json(); // parses JSON response into native JavaScript objects
                //console.log(response);
                }
            const form = document.querySelector('form');
            form.addEventListener('submit', handleSubmit);                  
          </script>
    </body>
